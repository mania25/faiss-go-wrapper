//
// Created by Abdurrahman on 21/01/20.
//

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "faiss_C.h"

#define VECTOR_DIMENSION 256

char *removeNewLine( char *s )
{
    char *n = malloc( strlen( s ? s : "\n" ) );
    if( s )
        strcpy( n, s );
    n[strlen(n)-1]='\0';
    return n;
}

void removeString (char text[], int start, int length) {
    int n = strlen(text), i;
    for (i = start+length; i <= n; i++) {
        text[i-length] = text[i];
    }
}

int main(int argc, char **argv) {
    char line[8196];
    char c;
    char *indexType = "OPQ8,IVF10_HNSW32,PQ8";
    char* indexFileName = "product_clusters_10.index";
    int count = 0;
    int i = 0;

    if (argc > 1) {
        if (strcmp(argv[1], "--add-vector-with-ids") == 0) // This is your parameter name
        {
            printf("VECTOR WITH IDS MODE.\n\n");
        }
    } else {
        printf("VECTOR WITHOUT IDS MODE.\n\n");
    }

    printf("Initializing FAISS DB. . .\n");
    FaissProductClusteringDB* faissProductClusteringDb = newFaissProductClusteringDB(256, indexType);
    InitFaissDB(faissProductClusteringDb);

    printf("Opening CSV file. . .\n");
    FILE *file;
    file = fopen("product_vectors.csv", "r");

    printf("Getting CSV total data. . .\n");
    for (c = getc(file); c != EOF; c = getc(file)) {
        if (c == '\n') { // Increment count if this character is newline
            count = count + 1;
        }
    }
    rewind(file);

    printf("Parsing CSV data. . .\n");
    char *vectors[count];
    char *pids[count];
    while (fgets(line, 8196, file))
    {
        char *columns = strtok(line, ";");
        pids[i] = columns;

        columns = strtok(NULL, ";");
        vectors[i] = removeNewLine(columns);

        i++;
    }

    printf("Normalizing CSV data. . .\n\n");
    for (int k = 0; k < count; ++k) {
        char *data = vectors[k];
        if (data == NULL) {
            continue;
        }

        for (int j = 0; j < strlen(data); ++j) {
            if (data[j] == '[' || data[j] == ']' || data[j] == ' ') {
                removeString(data, j, 1);
            }
        }
    }

    printf("Inserting data into FAISS train dataset. . .\n");
    for (int l = 0; l < count; ++l) {
        float vector[VECTOR_DIMENSION];
        int vectorIndex = 0;

        char *listOfVectors = strtok(vectors[l], ",");
        while( listOfVectors != NULL ) {
            vector[vectorIndex] = strtof(listOfVectors, NULL);
            listOfVectors = strtok(NULL, ",");

            vectorIndex++;
        }

        PushTrainDataVector(faissProductClusteringDb, vector);
    }
    printf("Query OK; %lu rows affected.\n", GetTrainDataSize(faissProductClusteringDb));

    printf("Validating training dataset. . .\n\n");
    ValidateTrainDataset(faissProductClusteringDb);

    printf("Building FAISS index. . .\n");
    BuildIndex(faissProductClusteringDb, count);

    printf("\nRetrieving FAISS index train status. . .\n");
    printf("Status: %d\n\n", GetTrainStatus(faissProductClusteringDb));

    printf("Adding new vector into FAISS. . .\n");
    for (int l = 0; l < count; ++l) {
        float vector[VECTOR_DIMENSION];
        long long pid[1];
        int vectorIndex = 0;

        char *listOfVectors = strtok(vectors[l], ",");
        while( listOfVectors != NULL ) {
            vector[vectorIndex] = strtof(listOfVectors, NULL);
            listOfVectors = strtok(NULL, ",");

            vectorIndex++;
        }

        pid[0] = atoll(pids[l]);
        if (argc > 1) {
            if (strcmp(argv[1], "--add-vector-with-ids") == 0) // This is your parameter name
            {
                AddNewVectorWithIDs(faissProductClusteringDb, 1, vector, pid);
            }
        } else {
            AddNewVector(faissProductClusteringDb, 1, vector);
        }
    }
    printf("Query OK; %d rows affected.\n\n", GetVectorTotal(faissProductClusteringDb));

    float vector[] = {0.14571473896503448, 0.024107684940099718, -0.18282538671046494, 0.26324476301670074, -0.1524293005466461, -0.03365216255187988, 0.07540634647011757, 0.03807032108306885, 0.16147031337022782, 0.2393225461244583, 0.5382165454328061, 0.2683560363948345, -0.184602814912796, 0.08540023565292358, -0.1992359697818756, 0.14904375225305558, 0.1941383086144924, -0.07795454859733582, -0.025608503818511964, 0.22726244032382964, 0.15052270703017712, -0.0672792762517929, 0.45772563852369785, -0.6363457560539245, 0.13080739974975586, 0.22538926601409912, 0.15284641236066818, -0.31351301576942203, 0.43625705391168595, -0.006841811537742615, -0.08362669870257378, -0.17744553685188294, 0.15800933986902238, -0.344541697204113, 0.25634400062263013, 0.43966216742992403, 0.39704264104366305, -0.156858591735363, -0.2133973330259323, 0.11397637128829956, 0.23759154826402665, -0.5325857013463974, -0.44963779151439665, 0.3282721519470215, -0.4925393745303154, -0.02799406796693802, 0.009280604124069215, -0.017588694393634797, 0.41540019363164904, 0.15871079191565513, 0.4427698478102684, 0.08013472706079483, 0.05301352217793465, 0.23232294917106627, 0.13482589572668074, 0.112095645070076, 0.04948647990822792, 0.6570896714925766, 0.1546045571565628, -0.12575967558659612, 0.0522979985922575, -0.4173324599862099, -0.2829327031970024, -0.303293102607131, -0.4433343395590782, 0.25172230005264284, -0.07045420110225678, 0.0400101900100708, -0.24245144724845885, -0.08320324905216694, -0.19308999180793762, 0.41080155968666077, 0.3699668228626251, 0.4597908318042755, -0.20355888307094575, -0.1853896215558052, -0.028391676768660546, -0.1078056588768959, -0.017286228947341442, 0.020597398281097412, 0.10286472588777543, 0.5241349592804909, -0.2837740141898394, 0.2642043620347977, 0.13873550444841384, -0.1635924782603979, 0.04640835970640182, -0.547969502210617, 0.48343696668744085, -0.18128472268581391, 0.19667701572179794, -0.19766865074634551, 0.22226903438568116, -0.05565261952579022, 0.2196018982678652, 0.039806869626045224, 0.5480835519731044, 0.48594468683004377, 0.016247248649597167, -0.20737511813640594, 0.06360454373061657, 0.2074104979634285, 0.3151002272963524, -0.4065379023551941, -0.029319775104522706, 0.05553458034992218, -0.1267937034368515, -0.023853926360607146, 0.12054666578769684, 0.028837742283940315, 0.17246523089706897, -0.0382146030664444, 0.40580642223358154, 0.15415625274181366, 0.0035813793540000914, -0.3670857667922974, -0.18226566053926946, 0.271294929087162, 0.10865659639239311, -0.047172261774539946, 0.006812689080834389, -0.36671471362933517, 0.23008856326341628, 0.5551695860922337, -0.4041724562644958, -0.2520000085234642, 0.09151054676622153, 0.6029499560594559, 0.07076624849517095, 0.015081042167462567, 0.12380203129233498, 0.24398415873905546, -0.12917856337796702, 0.07796702808455418, 0.054730974456393404, -0.04652964269840404, 0.10037344056916864, 0.2746231040280116, 0.1802176476554259, -0.07369947492292053, 0.07935615280937207, 0.23716259005136395, -0.41423075825074, 0.19582800746062085, 0.10640668065140121, 0.03812290098224031, 0.19176752335931124, 0.22067567005165314, 0.06506965637795235, 0.00039826608017871256, 0.22753192614273807, -0.26953878691174876, 0.0608017244621327, 0.014337892374513965, 0.2071336246965649, -0.22622550924700735, 0.3261922367505337, -0.004168625351188606, -0.19238950573765723, -0.10203668410203566, 0.00782781748689319, -0.26069683924709497, -0.08773241236217712, 0.14615090687661186, 0.4105335724736123, 0.08272497873067071, -0.3323455903507573, 0.1320046027632136, 0.0036290090065449476, -0.32774202819717557, -0.38770207056873723, 0.1326959060480524, -0.3413210284258974, -0.04937336367162827, 0.2642666636721084, -0.00544899035441248, -0.09439735629252698, 0.13093880247814874, 0.17911355775829993, 0.09744517073819511, 0.06149872909545114, -0.029570663151772397, 0.21464933043247775, 0.057836840268129505, -0.21181979091641934, 0.2938371474952682, -0.08648194854552123, -0.051008498988506436, 0.01869581051562962, -0.007032623808634908, 0.04010371951766214, -0.49898288675927016, -0.2278291148035542, 0.050200870505681165, -0.2321685593771307, -0.08788524441249472, -0.2140406205465919, -0.2798293741591471, 0.06705245360928147, 0.37097193114459515, 0.1956326342494178, 0.2724157880109392, -0.2730820931886372, -0.23545643641907527, 0.19145511546613356, 0.04111345161340738, -0.07284665904252936, -0.06673331120002426, 0.10392504852069051, 0.24470414435736051, -0.008039518945703381, 0.1808741577337251, 0.00487840896178233, -0.12092581515102402, 0.13377587431061425, -0.03780143090376729, 0.286291770416459, -0.08528793897283704, 0.2361433207988739, -0.1621122857751815, 0.21383077800764064, 0.010633421963767, 0.06512270125217344, -0.02517757015792947, 0.311577477541409, 0.19583905395120382, 0.05772535301941006, 0.1436051252347074, 0.011852445865147993, 0.11168859506908216, 0.20130959899765194, -0.42193189018258925, -0.23467948660254478, 0.009248298955801721, 0.1431263520039226, -0.1955760808808631, -0.003921491044916604, 0.1130866932829744, 0.0040371877839788795, 0.1589674192578777, 0.13554386453899114, -0.010382278773345445, -0.04208808887357775, -0.003976398751164149, -0.16139272384737668, -0.16708194836974144, 0.055194969068428405, -0.10273164145550445, -0.22132854786775025, -0.14837411571735223, 0.10923833397560213, 0.15285313845072923, -0.21837150354526544, 0.07468575209771332, 0.18761738843137496, 0.24264013944928975};
    float distanceResult[] = {};
    long long pidsResult[] = {};

    printf("Searching vector on FAISS. . .\n");
    SearchVector(faissProductClusteringDb, 1, vector, 4, distanceResult, pidsResult);

    printf("Printing search result. . .\n");
    printf("Distance: %f\n", distanceResult[0]);
    printf("Label: %lld\n\n", pidsResult[0]);

    printf("Saving FAISS index. . .");
    DumpFaissDB(faissProductClusteringDb, indexFileName);

    return 0;
}